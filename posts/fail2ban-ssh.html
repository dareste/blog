<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="Entre Dev Y Ops">
<title>Usando Fail2Ban para securizar SSH | Entre Dev Y Ops</title>
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="../assets/css/edyo.css" rel="stylesheet" type="text/css">
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<meta name="twitter:card" content="summary">
<meta name="og:url" content="http://www.entredevyops.es/posts/fail2ban-ssh.html">
<meta name="twitter:site:id" content="370552857">
<meta name="og:title" content="Usando Fail2Ban para securizar SSH">
<meta name="og:description" content="Hace poco realizando tareas de mantenimiento en mi servidor personal vi varios mensajes en los logs que no me gustaron nada: Failed password for root from 121.18.238.22 port 40618 ssh2.
Claramente mi ">
</head>
<body>

<div id="wrap">

    <!-- Menubar -->

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.entredevyops.es/">Entre Dev Y Ops</a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav navbar-right" id="main-navbar">
<li>
<a href="../tags/index.html"><i class="fa fa-tags"></i> Etiquetas</a>
                </li>
<li>
<a href="../archive.html"><i class="fa fa-archive"></i> Archivo</a>
                </li>
<li>
<a href="../podcast.html"><i class="fa fa-microphone"></i> Podcast</a>
                </li>
<li>
<a href="../acerca-de.html"><i class="fa fa-info-circle"></i> Acerca de...</a>

                        </li>
<li id="search-button"><a href="#" class="fa fa-search"></a></li>
                        </ul>
<form method="get" role="search" id="search" action="https://google.es/search" class="nav navbar-form">
<input type="hidden" name="as_sitesearch" value="http://www.entredevyops.es/"><input type="text" name="q" maxlength="255" placeholder="Buscar..." class="form-control"><input type="submit" value="Buscar">
</form>
                
            </div>
<!-- /.navbar-collapse -->
        </div>
    </nav><!-- End of Menubar --><div class="container">
        <div class="body-content">
            <!--Body content-->
    <article class="postbox clearfix"><h1 class="p-name" itemprop="headline name">Usando Fail2Ban para securizar SSH</h1>

            <ul class="pager">
<li class="previous">
        <a href="paginas-estaticas-amazon-2.html" title="Páginas estáticas en Amazon - 2" rel="prev">Post anterior</a>
        </li>
        <li class="next">
            <a href="podcast-episodio-18.html" title="Podcast Episodio 18: Entrevista a Xavi Soler" rel="next">Siguiente post</a>
        </li>
    </ul>
<div class="meta">
            <small>
                por <span class="author">David Acacio Albareda</span>
                el <time class="published" datetime="2016-09-08T15:30:00+02:00">08/09/2016</time>
                
                en     <span itemprop="keywords">
        <a class="tag p-category" href="../tags/fail2ban.html"><span class="badge badge-info">Fail2Ban</span></a>
        <a class="tag p-category" href="../tags/ssh.html"><span class="badge badge-info">SSH</span></a>
    </span>

            </small>
        </div>
        <p><img src="https://cloud.githubusercontent.com/assets/2761032/18147970/796bbae0-6fd7-11e6-91dc-feb4e6aa9afa.jpg" alt="Fail2Ban" class="align-left" height="80" width="200"></p>
<p>Hace poco realizando tareas de mantenimiento en mi servidor personal vi varios mensajes en los logs que no me gustaron nada: <em>Failed password for root from 121.18.238.22 port 40618 ssh2</em>.</p>
<p>Claramente mi servidor estaba bajo un ataque para conseguir acceso SSH.</p>
<!-- TEASER_END -->

<h2>Introducción</h2>
<p>En principio fue algo que no me preocupó, por lo que vi en los mensajes estaban intentando acceder con el usuario root y tenía el login deshabilitado, por tanto todo intento sería en vano. Pero igualmente es algo que no se tenía que tomar a la ligera, e igual que tenía ese servicio bajo ataque podría suceder con cualquier otro, sin olvidar que depende del origen del ataque podrían llegar a saturar el SSH y perder la gestión de mi máquina.</p>
<p>Para "protegerme" de esta situación me planteé dos opciones: </p>
<ol>
<li>Acudir a mi proveedor de servicios y contratar algún sistema de <a href="https://es.wikipedia.org/wiki/Sistema_de_detecci%C3%B3n_de_intrusos">IDS</a> con el coste que ello supone.</li>
<li>Montarme alguna solución en el propio servidor para controlar estas situaciones.</li>
</ol>
<p>Ya que se trataba de mi servidor personal, y no contiene ninguna información o servicio que considere crítico, me decanté por esta segunda opción, pero mi recomendación para entornos productivos es que os vayáis a la primera y siempre podéis complementarla con alguna otra solución.</p>
<p>Básicamente lo que quería era bloquear el tráfico de ciertas IPs a ciertos servicios y puertos. Esto lo podría hacer activando el firewall en el servidor, pero el problema es que este tipo de ataques no siempre provienen del mismo origen. Normalmente se suele utilizar diversos orígenes para evitar ser bloqueados, por tanto, necesitaba algún tipo de producto que, sin realizar análisis del tráfico que podría realizar un IDS, me permitiera ir bloqueando dinámicamente los accesos. La solución: <a href="http://www.fail2ban.org">Fail2Ban</a>.</p>
<p><a href="http://www.fail2ban.org">Fail2Ban</a> es un software open source programado en <a href="https://www.python.org/">Python</a> que escanea ficheros de log y detecta patrones que pueden ser identificados como "malvados" (p.e. intentos consecutivos de login como usuario root por ssh ;-) ) y bloquea las IPs mediante el firewall interno del servidor. También lo podemos configurar para realizar alguna otra acción como, por ejemplo, enviar un email. De base ya viene preconfigurado para soportar varios servidores (apache, ssh, nginx, etc...) pero también podemos configurar uno específico.</p>
<h2>Instalación</h2>
<p>A continuación os paso a explicar el proceso de instalación y una pequeña introducción a la configuración para proteger el servicio SSH. El taller lo iré realizando en una máquina virtual CentOS 6.8 pero la iré complementando con salidas y configuraciones de mi máquina pública para que se pueda ver el resultado en un entorno "real". Todos los comandos tienen que ser realizados con el usuario root.</p>
<p><a href="http://www.fail2ban.org">Fail2Ban</a> no se encuentra disponible en los repositorios base CentOS y será necesario que configuremos los repositorios de EPEL con el siguiente comando:</p>
<pre class="code literal-block"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">rpm</span> <span class="o">-</span><span class="n">Uvh</span> <span class="n">http</span><span class="o">:</span><span class="c1">//dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
<span class="n">Recuperando</span> <span class="n">http</span><span class="o">:</span><span class="c1">//dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
<span class="nl">advertencia:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">rpm</span><span class="o">-</span><span class="n">tmp</span><span class="p">.</span><span class="n">bkyK0z</span><span class="o">:</span> <span class="n">CabeceraV3</span> <span class="n">RSA</span><span class="o">/</span><span class="n">SHA256</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">ID</span> <span class="n">de</span> <span class="n">clave</span> <span class="mo">060</span><span class="mi">8</span><span class="n">b895</span><span class="o">:</span> <span class="n">NOKEY</span>
<span class="n">Preparando</span><span class="p">...</span>               <span class="err">###########################################</span> <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span>
   <span class="mi">1</span><span class="o">:</span><span class="n">epel</span><span class="o">-</span><span class="n">release</span>           <span class="err">###########################################</span> <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span>
</pre>


<p>Ahora ya podemos ejecutar la instalación con yum</p>
<pre class="code literal-block"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">fail2ban</span> <span class="o">-</span><span class="n">y</span>
<span class="n">Complementos</span> <span class="n">cargados</span><span class="o">:</span><span class="n">fastestmirror</span>
<span class="n">Configurando</span> <span class="n">el</span> <span class="n">proceso</span> <span class="n">de</span> <span class="n">instalaci</span><span class="err">ó</span><span class="n">n</span>
<span class="n">Loading</span> <span class="n">mirror</span> <span class="n">speeds</span> <span class="n">from</span> <span class="n">cached</span> <span class="n">hostfile</span>
<span class="n">epel</span><span class="o">/</span><span class="n">metalink</span>                                                                                                                                                                                                      <span class="o">|</span>  <span class="mi">21</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
 <span class="o">*</span> <span class="n">base</span><span class="o">:</span> <span class="n">centos</span><span class="p">.</span><span class="n">cadt</span><span class="p">.</span><span class="n">com</span>
 <span class="o">*</span> <span class="n">epel</span><span class="o">:</span> <span class="n">epel</span><span class="p">.</span><span class="n">besthosting</span><span class="p">.</span><span class="n">ua</span>
 <span class="o">*</span> <span class="n">extras</span><span class="o">:</span> <span class="n">centos</span><span class="p">.</span><span class="n">cadt</span><span class="p">.</span><span class="n">com</span>
 <span class="o">*</span> <span class="n">updates</span><span class="o">:</span> <span class="n">centos</span><span class="p">.</span><span class="n">cadt</span><span class="p">.</span><span class="n">com</span>
<span class="n">epel</span>                                                                                                                                                                                                               <span class="o">|</span> <span class="mf">4.3</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="n">epel</span><span class="o">/</span><span class="n">primary_db</span>                                                                                                                                                                                                    <span class="o">|</span> <span class="mf">5.0</span> <span class="n">MB</span>     <span class="mo">00</span><span class="o">:</span><span class="mi">12</span>
<span class="n">Resolviendo</span> <span class="n">dependencias</span>
<span class="o">--&gt;</span> <span class="n">Ejecutando</span> <span class="n">prueba</span> <span class="n">de</span> <span class="n">transacci</span><span class="err">ó</span><span class="n">n</span>
<span class="o">---&gt;</span> <span class="n">Package</span> <span class="n">fail2ban</span><span class="p">.</span><span class="n">noarch</span> <span class="mi">0</span><span class="o">:</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span> <span class="n">will</span> <span class="n">be</span> <span class="n">instalado</span>
<span class="o">--&gt;</span> <span class="n">Procesando</span> <span class="n">dependencias</span><span class="o">:</span> <span class="n">python</span><span class="o">-</span><span class="n">inotify</span> <span class="n">para</span> <span class="n">el</span> <span class="n">paquete</span><span class="o">:</span> <span class="n">fail2ban</span><span class="o">-</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span><span class="p">.</span><span class="n">noarch</span>
<span class="o">--&gt;</span> <span class="n">Procesando</span> <span class="n">dependencias</span><span class="o">:</span> <span class="n">ipset</span> <span class="n">para</span> <span class="n">el</span> <span class="n">paquete</span><span class="o">:</span> <span class="n">fail2ban</span><span class="o">-</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span><span class="p">.</span><span class="n">noarch</span>
<span class="o">--&gt;</span> <span class="n">Procesando</span> <span class="n">dependencias</span><span class="o">:</span> <span class="n">gamin</span><span class="o">-</span><span class="n">python</span> <span class="n">para</span> <span class="n">el</span> <span class="n">paquete</span><span class="o">:</span> <span class="n">fail2ban</span><span class="o">-</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span><span class="p">.</span><span class="n">noarch</span>
<span class="o">--&gt;</span> <span class="n">Procesando</span> <span class="n">dependencias</span><span class="o">:</span> <span class="n">ed</span> <span class="n">para</span> <span class="n">el</span> <span class="n">paquete</span><span class="o">:</span> <span class="n">fail2ban</span><span class="o">-</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span><span class="p">.</span><span class="n">noarch</span>
<span class="o">--&gt;</span> <span class="n">Ejecutando</span> <span class="n">prueba</span> <span class="n">de</span> <span class="n">transacci</span><span class="err">ó</span><span class="n">n</span>
<span class="o">---&gt;</span> <span class="n">Package</span> <span class="n">ed</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">1.1</span><span class="o">-</span><span class="mf">3.3</span><span class="p">.</span><span class="n">el6</span> <span class="n">will</span> <span class="n">be</span> <span class="n">instalado</span>
<span class="o">---&gt;</span> <span class="n">Package</span> <span class="n">gamin</span><span class="o">-</span><span class="n">python</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">0.1.10</span><span class="o">-</span><span class="mf">9.</span><span class="n">el6</span> <span class="n">will</span> <span class="n">be</span> <span class="n">instalado</span>
<span class="o">---&gt;</span> <span class="n">Package</span> <span class="n">ipset</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span> <span class="n">will</span> <span class="n">be</span> <span class="n">instalado</span>
<span class="o">--&gt;</span> <span class="n">Procesando</span> <span class="n">dependencias</span><span class="o">:</span> <span class="n">libmnl</span><span class="p">.</span><span class="n">so</span><span class="mf">.0</span><span class="p">(</span><span class="n">LIBMNL_1</span><span class="mf">.0</span><span class="p">)</span> <span class="n">para</span> <span class="n">el</span> <span class="n">paquete</span><span class="o">:</span> <span class="n">ipset</span><span class="o">-</span><span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>
<span class="o">--&gt;</span> <span class="n">Procesando</span> <span class="n">dependencias</span><span class="o">:</span> <span class="n">libmnl</span><span class="p">.</span><span class="n">so</span><span class="mf">.0</span> <span class="n">para</span> <span class="n">el</span> <span class="n">paquete</span><span class="o">:</span> <span class="n">ipset</span><span class="o">-</span><span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>
<span class="o">---&gt;</span> <span class="n">Package</span> <span class="n">python</span><span class="o">-</span><span class="n">inotify</span><span class="p">.</span><span class="n">noarch</span> <span class="mi">0</span><span class="o">:</span><span class="mf">0.9.1</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span> <span class="n">will</span> <span class="n">be</span> <span class="n">instalado</span>
<span class="o">--&gt;</span> <span class="n">Ejecutando</span> <span class="n">prueba</span> <span class="n">de</span> <span class="n">transacci</span><span class="err">ó</span><span class="n">n</span>
<span class="o">---&gt;</span> <span class="n">Package</span> <span class="n">libmnl</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">1.0.2</span><span class="o">-</span><span class="mf">3.</span><span class="n">el6</span> <span class="n">will</span> <span class="n">be</span> <span class="n">instalado</span>
<span class="o">--&gt;</span> <span class="n">Resoluci</span><span class="err">ó</span><span class="n">n</span> <span class="n">de</span> <span class="n">dependencias</span> <span class="n">finalizada</span>

<span class="n">Dependencias</span> <span class="n">resueltas</span>

<span class="o">==========================================================================================================================================================================================================================================</span>
 <span class="n">Paquete</span>                                                      <span class="n">Arquitectura</span>                                         <span class="n">Versi</span><span class="err">ó</span><span class="n">n</span>                                                       <span class="n">Repositorio</span>                                        <span class="n">Tama</span><span class="err">ñ</span><span class="n">o</span>
<span class="o">==========================================================================================================================================================================================================================================</span>
<span class="nl">Instalando:</span>
 <span class="n">fail2ban</span>                                                     <span class="n">noarch</span>                                               <span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span>                                                 <span class="n">epel</span>                                               <span class="mi">419</span> <span class="n">k</span>
<span class="n">Instalando</span> <span class="n">para</span> <span class="n">las</span> <span class="n">dependencias</span><span class="o">:</span>
 <span class="n">ed</span>                                                           <span class="n">i686</span>                                                 <span class="mf">1.1</span><span class="o">-</span><span class="mf">3.3</span><span class="p">.</span><span class="n">el6</span>                                                   <span class="n">base</span>                                                <span class="mi">70</span> <span class="n">k</span>
 <span class="n">gamin</span><span class="o">-</span><span class="n">python</span>                                                 <span class="n">i686</span>                                                 <span class="mf">0.1.10</span><span class="o">-</span><span class="mf">9.</span><span class="n">el6</span>                                                  <span class="n">base</span>                                                <span class="mi">33</span> <span class="n">k</span>
 <span class="n">ipset</span>                                                        <span class="n">i686</span>                                                 <span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span>                                                    <span class="n">base</span>                                                <span class="mi">63</span> <span class="n">k</span>
 <span class="n">libmnl</span>                                                       <span class="n">i686</span>                                                 <span class="mf">1.0.2</span><span class="o">-</span><span class="mf">3.</span><span class="n">el6</span>                                                   <span class="n">base</span>                                                <span class="mi">22</span> <span class="n">k</span>
 <span class="n">python</span><span class="o">-</span><span class="n">inotify</span>                                               <span class="n">noarch</span>                                               <span class="mf">0.9.1</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span>                                                   <span class="n">epel</span>                                                <span class="mi">50</span> <span class="n">k</span>

<span class="n">Resumen</span> <span class="n">de</span> <span class="n">la</span> <span class="n">transacci</span><span class="err">ó</span><span class="n">n</span>
<span class="o">==========================================================================================================================================================================================================================================</span>
<span class="n">Instalar</span>       <span class="mi">6</span> <span class="n">Paquete</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">Tama</span><span class="err">ñ</span><span class="n">o</span> <span class="n">total</span> <span class="n">de</span> <span class="n">la</span> <span class="n">descarga</span><span class="o">:</span> <span class="mi">656</span> <span class="n">k</span>
<span class="n">Tama</span><span class="err">ñ</span><span class="n">o</span> <span class="n">instalado</span><span class="o">:</span> <span class="mf">2.0</span> <span class="n">M</span>
<span class="n">Descargando</span> <span class="n">paquetes</span><span class="o">:</span>
<span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span> <span class="n">ed</span><span class="o">-</span><span class="mf">1.1</span><span class="o">-</span><span class="mf">3.3</span><span class="p">.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span><span class="p">.</span><span class="n">rpm</span>                                                                                                                                                                                     <span class="o">|</span>  <span class="mi">70</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span> <span class="n">fail2ban</span><span class="o">-</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span><span class="p">.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span>                                                                                                                                                                           <span class="o">|</span> <span class="mi">419</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">01</span>
<span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span> <span class="n">gamin</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="mf">0.1.10</span><span class="o">-</span><span class="mf">9.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span><span class="p">.</span><span class="n">rpm</span>                                                                                                                                                                          <span class="o">|</span>  <span class="mi">33</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span> <span class="n">ipset</span><span class="o">-</span><span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span><span class="p">.</span><span class="n">rpm</span>                                                                                                                                                                                   <span class="o">|</span>  <span class="mi">63</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span> <span class="n">libmnl</span><span class="o">-</span><span class="mf">1.0.2</span><span class="o">-</span><span class="mf">3.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span><span class="p">.</span><span class="n">rpm</span>                                                                                                                                                                                 <span class="o">|</span>  <span class="mi">22</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="p">(</span><span class="mi">6</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span> <span class="n">python</span><span class="o">-</span><span class="n">inotify</span><span class="o">-</span><span class="mf">0.9.1</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="p">.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span>                                                                                                                                                                       <span class="o">|</span>  <span class="mi">50</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="o">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="n">Total</span>                                                                                                                                                                                                     <span class="mi">154</span> <span class="n">kB</span><span class="o">/</span><span class="n">s</span> <span class="o">|</span> <span class="mi">656</span> <span class="n">kB</span>     <span class="mo">00</span><span class="o">:</span><span class="mo">04</span>
<span class="nl">advertencia:</span><span class="n">rpmts_HdrFromFdno</span><span class="o">:</span> <span class="n">CabeceraV3</span> <span class="n">RSA</span><span class="o">/</span><span class="n">SHA1</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">ID</span> <span class="n">de</span> <span class="n">clave</span> <span class="n">c105b9de</span><span class="o">:</span> <span class="n">NOKEY</span>
<span class="n">Retrieving</span> <span class="n">key</span> <span class="n">from</span> <span class="n">file</span><span class="o">:</span><span class="c1">///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6</span>
<span class="n">Importing</span> <span class="n">GPG</span> <span class="n">key</span> <span class="mh">0xC105B9DE</span><span class="o">:</span>
 <span class="n">Userid</span> <span class="o">:</span> <span class="n">CentOS</span><span class="o">-</span><span class="mi">6</span> <span class="n">Key</span> <span class="p">(</span><span class="n">CentOS</span> <span class="mi">6</span> <span class="n">Official</span> <span class="n">Signing</span> <span class="n">Key</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">centos</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="n">key</span><span class="err">@</span><span class="n">centos</span><span class="p">.</span><span class="n">org</span><span class="o">&gt;</span>
 <span class="nl">Package:</span> <span class="n">centos</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mf">8.</span><span class="n">el6</span><span class="p">.</span><span class="n">centos</span><span class="mf">.12.3</span><span class="p">.</span><span class="n">i686</span> <span class="p">(</span><span class="err">@</span><span class="n">anaconda</span><span class="o">-</span><span class="n">CentOS</span><span class="o">-</span><span class="mf">201605211917.</span><span class="n">i386</span><span class="o">/</span><span class="mf">6.8</span><span class="p">)</span>
 <span class="n">From</span>   <span class="o">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">rpm</span><span class="o">-</span><span class="n">gpg</span><span class="o">/</span><span class="n">RPM</span><span class="o">-</span><span class="n">GPG</span><span class="o">-</span><span class="n">KEY</span><span class="o">-</span><span class="n">CentOS</span><span class="o">-</span><span class="mi">6</span>
<span class="nl">warning:</span> <span class="n">rpmts_HdrFromFdno</span><span class="o">:</span> <span class="n">Header</span> <span class="n">V3</span> <span class="n">RSA</span><span class="o">/</span><span class="n">SHA256</span> <span class="n">Signature</span><span class="p">,</span> <span class="n">key</span> <span class="n">ID</span> <span class="mo">060</span><span class="mi">8</span><span class="n">b895</span><span class="o">:</span> <span class="n">NOKEY</span>
<span class="n">Retrieving</span> <span class="n">key</span> <span class="n">from</span> <span class="n">file</span><span class="o">:</span><span class="c1">///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</span>
<span class="n">Importing</span> <span class="n">GPG</span> <span class="n">key</span> <span class="mh">0x0608B895</span><span class="o">:</span>
 <span class="n">Userid</span> <span class="o">:</span> <span class="n">EPEL</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">&lt;</span><span class="n">epel</span><span class="err">@</span><span class="n">fedoraproject</span><span class="p">.</span><span class="n">org</span><span class="o">&gt;</span>
 <span class="nl">Package:</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mf">8.</span><span class="n">noarch</span> <span class="p">(</span><span class="n">installed</span><span class="p">)</span>
 <span class="n">From</span>   <span class="o">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">rpm</span><span class="o">-</span><span class="n">gpg</span><span class="o">/</span><span class="n">RPM</span><span class="o">-</span><span class="n">GPG</span><span class="o">-</span><span class="n">KEY</span><span class="o">-</span><span class="n">EPEL</span><span class="o">-</span><span class="mi">6</span>
<span class="n">Ejecutando</span> <span class="n">el</span> <span class="n">rpm_check_debug</span>
<span class="n">Ejecutando</span> <span class="n">prueba</span> <span class="n">de</span> <span class="n">transacci</span><span class="err">ó</span><span class="n">n</span>
<span class="n">La</span> <span class="n">prueba</span> <span class="n">de</span> <span class="n">transacci</span><span class="err">ó</span><span class="n">n</span> <span class="n">ha</span> <span class="n">sido</span> <span class="n">exitosa</span>
<span class="n">Ejecutando</span> <span class="n">transacci</span><span class="err">ó</span><span class="n">n</span>
<span class="nl">Advertencia:</span> <span class="n">Las</span> <span class="n">bases</span> <span class="n">de</span> <span class="n">datos</span> <span class="p">(</span><span class="n">RPMDB</span><span class="p">)</span> <span class="n">han</span> <span class="n">sido</span> <span class="n">modificadas</span> <span class="n">por</span> <span class="n">un</span> <span class="n">elemento</span> <span class="n">ajeno</span> <span class="n">a</span> <span class="n">yum</span><span class="p">.</span>
  <span class="n">Instalando</span>    <span class="o">:</span> <span class="n">python</span><span class="o">-</span><span class="n">inotify</span><span class="o">-</span><span class="mf">0.9.1</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="p">.</span><span class="n">noarch</span>                                                                                                                                                                                   <span class="mi">1</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Instalando</span>    <span class="o">:</span> <span class="n">ed</span><span class="o">-</span><span class="mf">1.1</span><span class="o">-</span><span class="mf">3.3</span><span class="p">.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                                 <span class="mi">2</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Instalando</span>    <span class="o">:</span> <span class="n">gamin</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="mf">0.1.10</span><span class="o">-</span><span class="mf">9.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                      <span class="mi">3</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Instalando</span>    <span class="o">:</span> <span class="n">libmnl</span><span class="o">-</span><span class="mf">1.0.2</span><span class="o">-</span><span class="mf">3.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                             <span class="mi">4</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Instalando</span>    <span class="o">:</span> <span class="n">ipset</span><span class="o">-</span><span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                               <span class="mi">5</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Instalando</span>    <span class="o">:</span> <span class="n">fail2ban</span><span class="o">-</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span><span class="p">.</span><span class="n">noarch</span>                                                                                                                                                                                       <span class="mi">6</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Verifying</span>     <span class="o">:</span> <span class="n">libmnl</span><span class="o">-</span><span class="mf">1.0.2</span><span class="o">-</span><span class="mf">3.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                             <span class="mi">1</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Verifying</span>     <span class="o">:</span> <span class="n">fail2ban</span><span class="o">-</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span><span class="p">.</span><span class="n">noarch</span>                                                                                                                                                                                       <span class="mi">2</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Verifying</span>     <span class="o">:</span> <span class="n">gamin</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="mf">0.1.10</span><span class="o">-</span><span class="mf">9.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                      <span class="mi">3</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Verifying</span>     <span class="o">:</span> <span class="n">ipset</span><span class="o">-</span><span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                               <span class="mi">4</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Verifying</span>     <span class="o">:</span> <span class="n">python</span><span class="o">-</span><span class="n">inotify</span><span class="o">-</span><span class="mf">0.9.1</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="p">.</span><span class="n">noarch</span>                                                                                                                                                                                   <span class="mi">5</span><span class="o">/</span><span class="mi">6</span>
  <span class="n">Verifying</span>     <span class="o">:</span> <span class="n">ed</span><span class="o">-</span><span class="mf">1.1</span><span class="o">-</span><span class="mf">3.3</span><span class="p">.</span><span class="n">el6</span><span class="p">.</span><span class="n">i686</span>                                                                                                                                                                                                 <span class="mi">6</span><span class="o">/</span><span class="mi">6</span>

<span class="nl">Instalado:</span>
  <span class="n">fail2ban</span><span class="p">.</span><span class="n">noarch</span> <span class="mi">0</span><span class="o">:</span><span class="mf">0.9.3</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span><span class="mf">.1</span>

<span class="n">Dependencia</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">instalada</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ed</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">1.1</span><span class="o">-</span><span class="mf">3.3</span><span class="p">.</span><span class="n">el6</span>                   <span class="n">gamin</span><span class="o">-</span><span class="n">python</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">0.1.10</span><span class="o">-</span><span class="mf">9.</span><span class="n">el6</span>                   <span class="n">ipset</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">6.11</span><span class="o">-</span><span class="mf">4.</span><span class="n">el6</span>                   <span class="n">libmnl</span><span class="p">.</span><span class="n">i686</span> <span class="mi">0</span><span class="o">:</span><span class="mf">1.0.2</span><span class="o">-</span><span class="mf">3.</span><span class="n">el6</span>                   <span class="n">python</span><span class="o">-</span><span class="n">inotify</span><span class="p">.</span><span class="n">noarch</span> <span class="mi">0</span><span class="o">:</span><span class="mf">0.9.1</span><span class="o">-</span><span class="mf">1.</span><span class="n">el6</span>

<span class="err">¡</span><span class="n">Listo</span><span class="o">!</span>
</pre>


<p>El programa se compone de dos partes importantes:
<em> La parte de servidor (daemon), que estará vigilando los diferentes ficheros de log en busca de patrones y creando los bloqueos necesarios.
</em> La parte cliente, que servirá para interactuar con el servidor y hacer consultas (p.e. número de bloqueos) o incluso aplicar configuraciones "en caliente".</p>
<p>La estructura de directorios y ficheros que genera la instalación es la siguiente:</p>
<pre class="code literal-block"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">/</span><span class="p">]</span><span class="err">#</span> <span class="n">ls</span> <span class="o">-</span><span class="n">lrt</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span>
<span class="n">total</span> <span class="mi">60</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">290</span> <span class="n">ago</span>  <span class="mi">1</span>  <span class="mi">2015</span> <span class="n">paths</span><span class="o">-</span><span class="n">osx</span><span class="p">.</span><span class="n">conf</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">1174</span> <span class="n">ago</span>  <span class="mi">1</span>  <span class="mi">2015</span> <span class="n">paths</span><span class="o">-</span><span class="n">freebsd</span><span class="p">.</span><span class="n">conf</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">743</span> <span class="n">ago</span>  <span class="mi">1</span>  <span class="mi">2015</span> <span class="n">paths</span><span class="o">-</span><span class="n">fedora</span><span class="p">.</span><span class="n">conf</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>   <span class="mi">642</span> <span class="n">ago</span>  <span class="mi">1</span>  <span class="mi">2015</span> <span class="n">paths</span><span class="o">-</span><span class="n">debian</span><span class="p">.</span><span class="n">conf</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">1939</span> <span class="n">ago</span>  <span class="mi">1</span>  <span class="mi">2015</span> <span class="n">paths</span><span class="o">-</span><span class="n">common</span><span class="p">.</span><span class="n">conf</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">18558</span> <span class="n">oct</span> <span class="mi">17</span>  <span class="mi">2015</span> <span class="n">jail</span><span class="p">.</span><span class="n">conf</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">.</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">2313</span> <span class="n">oct</span> <span class="mi">17</span>  <span class="mi">2015</span> <span class="n">fail2ban</span><span class="p">.</span><span class="n">conf</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="p">.</span> <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">4096</span> <span class="n">oct</span> <span class="mi">17</span>  <span class="mi">2015</span> <span class="n">jail</span><span class="p">.</span><span class="n">d</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="p">.</span> <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">4096</span> <span class="n">oct</span> <span class="mi">17</span>  <span class="mi">2015</span> <span class="n">fail2ban</span><span class="p">.</span><span class="n">d</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="p">.</span> <span class="mi">3</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">4096</span> <span class="n">sep</span>  <span class="mi">5</span> <span class="mi">15</span><span class="o">:</span><span class="mi">13</span> <span class="n">filter</span><span class="p">.</span><span class="n">d</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="p">.</span> <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">4096</span> <span class="n">sep</span>  <span class="mi">5</span> <span class="mi">15</span><span class="o">:</span><span class="mi">13</span> <span class="n">action</span><span class="p">.</span><span class="n">d</span>
</pre>


<p>Ahora ha llegado el momento de configurar una prisión (jail en <a href="http://www.fail2ban.org">Fail2Ban</a>) que básicamente consiste en definir un servicio a monitorizar y unas acciones a realizar. Como he dicho nos interesa controlar el SSH, para esto crearemos el fichero jail.local en la misma ruta:</p>
<pre class="code literal-block"><span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">jail</span><span class="p">.</span><span class="n">local</span>
</pre>


<p>Y pondremos el siguiente contenido:</p>
<pre class="code literal-block"><span class="k">[DEFAULT]</span>
<span class="c1"># Tiempo que bloqueramos la IP: 3600 segundos (1 hora)</span>
<span class="na">bantime</span> <span class="o">=</span> <span class="s">3600</span>

<span class="c1"># La acción que de bloqueo será a traves del firewall interno (iptables)</span>
<span class="na">banaction</span> <span class="o">=</span> <span class="s">iptables-multiport</span>

<span class="err">[sshd]</span> <span class="c1">#activamos el jail para el demonio de ssh</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>
</pre>


<p>Arrancamos el demonio:</p>
<pre class="code literal-block"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">/</span><span class="p">]</span><span class="err">#</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">fail2ban</span> <span class="n">start</span>
<span class="n">Iniciando</span> <span class="n">fail2ban</span><span class="o">:</span>                                        <span class="p">[</span>  <span class="n">OK</span>  <span class="p">]</span>
</pre>


<p>Consultamos, a través del cliente, que jails tenemos activos:</p>
<pre class="code literal-block"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">/</span><span class="p">]</span><span class="err">#</span> <span class="n">fail2ban</span><span class="o">-</span><span class="n">client</span> <span class="n">status</span>
<span class="n">Status</span>
<span class="o">|-</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">jail</span><span class="o">:</span>      <span class="mi">1</span>
<span class="err">`</span><span class="o">-</span> <span class="n">Jail</span> <span class="n">list</span><span class="o">:</span>   <span class="n">sshd</span>
</pre>


<p>Y podemos consultar en detalle el estado de ese jail:</p>
<pre class="code literal-block"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">/</span><span class="p">]</span><span class="err">#</span> <span class="n">fail2ban</span><span class="o">-</span><span class="n">client</span> <span class="n">status</span> <span class="n">sshd</span>
<span class="n">Status</span> <span class="k">for</span> <span class="n">the</span> <span class="n">jail</span><span class="o">:</span> <span class="n">sshd</span>
<span class="o">|-</span> <span class="n">Filter</span>
<span class="o">|</span>  <span class="o">|-</span> <span class="n">Currently</span> <span class="n">failed</span><span class="o">:</span> <span class="mi">0</span>
<span class="o">|</span>  <span class="o">|-</span> <span class="n">Total</span> <span class="n">failed</span><span class="o">:</span>     <span class="mi">0</span>
<span class="o">|</span>  <span class="err">`</span><span class="o">-</span> <span class="n">File</span> <span class="n">list</span><span class="o">:</span>        <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">secure</span>
<span class="err">`</span><span class="o">-</span> <span class="n">Actions</span>
   <span class="o">|-</span> <span class="n">Currently</span> <span class="n">banned</span><span class="o">:</span> <span class="mi">0</span>
   <span class="o">|-</span> <span class="n">Total</span> <span class="n">banned</span><span class="o">:</span>     <span class="mi">0</span>
   <span class="err">`</span><span class="o">-</span> <span class="n">Banned</span> <span class="n">IP</span> <span class="n">list</span><span class="o">:</span>
</pre>


<p>En este caso nos indica que no ha localizado ningún fallo de autentificación, que monitoriza el fichero /var/log/secure (donde deja las trazas por defecto el demonio sshd) y que no ha realizado ninguna acción.</p>
<p>A continuación os voy a dejar la salida del mismo comando pero de mi servidor público que lleva unos 15 días funcionando para que comparéis los resultados:</p>
<pre class="code literal-block"><span class="n">Status</span> <span class="k">for</span> <span class="n">the</span> <span class="n">jail</span><span class="o">:</span> <span class="n">sshd</span>
<span class="o">|-</span> <span class="n">Filter</span>
<span class="o">|</span>  <span class="o">|-</span> <span class="n">Currently</span> <span class="n">failed</span><span class="o">:</span> <span class="mi">0</span>
<span class="o">|</span>  <span class="o">|-</span> <span class="n">Total</span> <span class="n">failed</span><span class="o">:</span>     <span class="mi">6445</span>
<span class="o">|</span>  <span class="err">`</span><span class="o">-</span> <span class="n">File</span> <span class="n">list</span><span class="o">:</span>        <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">secure</span>
<span class="err">`</span><span class="o">-</span> <span class="n">Actions</span>
   <span class="o">|-</span> <span class="n">Currently</span> <span class="n">banned</span><span class="o">:</span> <span class="mi">0</span>
   <span class="o">|-</span> <span class="n">Total</span> <span class="n">banned</span><span class="o">:</span>     <span class="mi">562</span>
   <span class="err">`</span><span class="o">-</span> <span class="n">Banned</span> <span class="n">IP</span> <span class="n">list</span><span class="o">:</span>
</pre>


<p>Podéis ver que ha localizado 6445 fallos y ha bloqueado un total de 562 IPs. Actualmente no tiene ninguna IP bloqueada (se estarán cansado ;-) ).</p>
<h2>A tener en cuenta</h2>
<ul>
<li>Para evitar posibles bloqueos no deseados (por ejemplo el de nuestra IP de acceso) podemos definir un rango de exclusión para que se ignoren los orígenes de dichas IPs con el parámetro <em>ignoreip</em>
</li>
<li>Mi recomendación es definir tiempos de bloqueo bajos para que, en caso de accidente, podamos recuperar el acceso a nuestro servidor. He comprobado que una hora es suficientemente disuasorio.</li>
<li>Podéis ver los jails disponibles listando el contenido del fichero <em>/etc/fail2ban/jail.conf</em> y hacer lo mismo que hemos hecho para el sshd.</li>
<li>Recordad tener activado los servicios de <em>iptables</em> y <em>fail2ban</em>.</li>
<li>Os dejo un ejemplo de configuración para el servidor web <a href="https://www.nginx.com/resources/wiki/">nginx</a> dando servicio a diferentes dominios y con diferentes ficheros de log:</li>
</ul>
<pre class="code literal-block"><span class="k">[nginx-botsearch]</span>

<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">port</span>     <span class="o">=</span> <span class="s">http,https</span>
<span class="na">logpath</span> <span class="o">=</span> <span class="s">/var/log/nginx/error.log</span>
<span class="s">        /var/log/nginx/*/error.log</span>
<span class="na">maxretry</span> <span class="o">=</span> <span class="s">2</span>
</pre>


<p>Espero que os sea útil y espero vuestro feedback.</p>
    </article><div class="pager row">
        <div class="previous col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <div>Post anterior</div>
            <a href="paginas-estaticas-amazon-2.html" rel="prev">Páginas estáticas en Amazon - 2</a>
        </div>
        <div class="next col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <div>Siguiente post</div>
            <a href="podcast-episodio-18.html" rel="next">Podcast Episodio 18: Entrevista a Xavi Soler</a>
        </div>
    </div>

                    <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="edyo",
            disqus_url="http://www.entredevyops.es/posts/fail2ban-ssh.html",
        disqus_title="Usando Fail2Ban para securizar SSH",
        disqus_identifier="cache/posts/2016-09-08-dacacio-fail2ban-ssh.html",
        disqus_config = function () {
            this.language = "es_ES";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>JavaScript debe estar activado para ver los <a href="http://disqus.com/?ref_noscript" rel="nofollow">comentarios con Disqus.</a>
</noscript>
    <a href="http://disqus.com" class="dsq-brlink" rel="nofollow">Comentarios con <span class="logo-disqus">Disqus</span></a>


    
            <!--End of body content-->
        </div>
    </div>

</div>

<footer><div class="container">
        Suscríbete a nuestro <a href="http://www.entredevyops.es/rss.xml">RSS <i class="fa fa-rss"></i></a> o síguenos en <a href="https://twitter.com/entredevyops">Twitter <i class="fa fa-twitter"></i></a><br>© 2017 Entre Dev Y Ops por los <a href="http://www.entredevyops.es/acerca-de.html#authors">autores</a> bajo <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.es_ES">Licencia <img alt="Licencia Creative Commons" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" height="15px" width="80px"></a> — Powered by <a href="http://getnikola.com">Nikola</a>
    </div>
</footer><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script><script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script><script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script>
        $( "#search-button" ).click(toggle_search);
        function toggle_search() {
            $('#main-navbar').children().each(
                function() {
                    if ($(this).attr('id') != 'search-button') {
                        console.log($(this).attr('id'));
                        $(this).toggle();
                    };
                }
            );
            $( "#search" ).toggle();
        }
    </script><script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25613214-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
