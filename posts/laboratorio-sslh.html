<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="Entre Dev Y Ops">
<title>Laboratorio de sslh: Un puerto para dominarlos a todos | Entre Dev Y Ops</title>
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="../assets/css/edyo.css" rel="stylesheet" type="text/css">
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<meta name="twitter:card" content="summary">
<meta name="og:url" content="http://www.entredevyops.es/posts/laboratorio-sslh.html">
<meta name="twitter:site:id" content="370552857">
<meta name="og:title" content="Laboratorio de sslh: Un puerto para dominarlos a todos">
<meta name="og:description" content="En muchas redes corporativas me estoy encontrado que una manera que tienen los administradores de controlar la actividad de sus usuarios es bloquear el acceso de los clientes a ciertos puertos mediant">
</head>
<body>

<div id="wrap">

    <!-- Menubar -->

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.entredevyops.es/">Entre Dev Y Ops</a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav navbar-right" id="main-navbar">
<li>
<a href="../tags/index.html"><i class="fa fa-tags"></i> Etiquetas</a>
                </li>
<li>
<a href="../archive.html"><i class="fa fa-archive"></i> Archivo</a>
                </li>
<li>
<a href="../podcast.html"><i class="fa fa-microphone"></i> Podcast</a>
                </li>
<li>
<a href="../acerca-de.html"><i class="fa fa-info-circle"></i> Acerca de...</a>

                        </li>
<li id="search-button"><a href="#" class="fa fa-search"></a></li>
                        </ul>
<form method="get" role="search" id="search" action="https://google.es/search" class="nav navbar-form">
<input type="hidden" name="as_sitesearch" value="http://www.entredevyops.es/"><input type="text" name="q" maxlength="255" placeholder="Buscar..." class="form-control"><input type="submit" value="Buscar">
</form>
                
            </div>
<!-- /.navbar-collapse -->
        </div>
    </nav><!-- End of Menubar --><div class="container">
        <div class="body-content">
            <!--Body content-->
    <article class="postbox clearfix"><h1 class="p-name" itemprop="headline name">Laboratorio de sslh: Un puerto para dominarlos a todos</h1>

            <ul class="pager">
<li class="previous">
        <a href="tiquets-primeros-ponentes-NoSQL-matters-BCN-2014.html" title="Tiquets y primeros ponentes de la NoSQL matters BCN 2014 ya disponibles" rel="prev">Post anterior</a>
        </li>
        <li class="next">
            <a href="11-cosas-necesitas-saber-devops-11.html" title="11 cosas sobre DevOps (11): Mi tercer patrón DevOps favorito" rel="next">Siguiente post</a>
        </li>
    </ul>
<div class="meta">
            <small>
                por <span class="author">David Acacio</span>
                el <time class="published" datetime="2014-08-27T19:55:00+02:00">27/08/2014</time>
                
                en     <span itemprop="keywords">
        <a class="tag p-category" href="../tags/laboratorio.html"><span class="badge badge-info">Laboratorio</span></a>
        <a class="tag p-category" href="../tags/sslh.html"><span class="badge badge-info">sslh</span></a>
    </span>

            </small>
        </div>
        <p>En muchas redes corporativas me estoy encontrado que una manera que tienen los administradores de controlar la actividad de sus usuarios es bloquear el acceso de los clientes a ciertos puertos mediante reglas de firewall (por ejemplo denegar toda conexión al puerto 22 o solo permitir conexiones al puerto 80 o 443). Medida para nada afectiva, ya que no garantiza que el usuario no se conecte al servicio no deseado, sino que no se conecte al puerto por defecto de dicho servicio. Para saltarse esta restricción es tan sencillo como configurar el servicio en uno de los puertos permitidos.</p>
<p>Si bien es cierto que puede ser bastante molesto, ya que obliga a modificar configuraciones, puede suponer un problema si ya tenemos un servicio activo en el puerto requerido. Esto me motivó a buscar la manera de, a través de un único puerto de un servidor, se pudiera acceder a diversos servicios.</p>
<!-- TEASER_END -->
<p>Después de unas búsquedas localicé diversas opciones, pero casi todas ellas implicaban complejas configuraciones de iptables, cosa poco práctica. Finalmente encontré la respuesta a todas mis oraciones: <a class="reference external" href="https://github.com/yrutschle/sslh">sslh</a></p>
<p><a class="reference external" href="https://github.com/yrutschle/sslh">Sslh</a> es un programa desarrollado en <a class="reference external" href="http://es.wikipedia.org/wiki/C_(lenguaje_de_programaci%C3%B3n)">C</a> por <a class="reference external" href="http://www.rutschle.net/cv/rutschle_en.pdf">Yves Rütschlé</a>. La manera de funcionar es "simple": se queda escuchando en un puerto y cuando recibe una conexión va probando los diversos servicios que tiene configurados hasta dar con el adecuado. Actualmente soporta de manera nativa los siguientes: ssh, openvpn, tinc, xmpp, http, ssl y tls. También es posible especificar otros protocolos en el fichero de configuración mediante expresiones regulares.</p>
<p>Podéis localizar la última versión del programa en <a class="reference external" href="https://github.com/yrutschle/sslh">el repositorio de Github</a>.</p>
<p>A continuación os vamos a detallar, paso a paso, como realizar la instalación de esta herramienta. En el ejemplo hemos utilizado una <a class="reference external" href="http://www.centos.org">CentOS</a> 6.5.</p>
<p>Primero instalaremos las dependencias de librerías y el compilador gcc:</p>
<pre class="code bash literal-block">
yum install -y libconfig libconfig-devel gcc git
</pre>
<p>Bajamos la última versión del código fuente de github (p.e. en la carpeta opt):</p>
<pre class="code bash literal-block">
mkdir /opt/sslh
<span class="nb">cd</span> /opt/sslh
git init
git pull https://github.com/yrutschle/sslh
</pre>
<p>Y realizamos la compilación:</p>
<pre class="code bash literal-block">
make install
</pre>
<p>Ahora copiaremos el script de arranque al init.d para poder realizar un arranque automático del servicio en runlevel 3:</p>
<pre class="code bash literal-block">
cp scripts/etc.rc.d.init.d.sslh.centos /etc/rc.d/init.d/sslh
ln -s /usr/local/sbin/sslh /usr/sbin/sslh-select
chkconfig --add sslh
chkconfig --level 3 sslh on
</pre>
<p>Y por último pondremos el fichero de configuración:</p>
<pre class="code bash literal-block">
cp basic.cfg /etc/sslh.cfg
</pre>
<p>Dentro de dicho fichero modificaremos los parámetros que necesitemos, en este caso los siguientes:</p>
<ul class="simple">
<li>Sección listen: indicaremos una sola línea con la IP/HOST de nuestro interfaz de red y el puerto al cual queremos que el servicio esté escuchando:</li>
</ul>
<pre class="code bash literal-block">
listen:
<span class="o">(</span>
        <span class="o">{</span> host: <span class="s2">"192.168.10.224"</span>; port: <span class="s2">"8081"</span>; <span class="o">}</span>
<span class="o">)</span>;
</pre>
<ul class="simple">
<li>Sección protocols: indicaremos una línea por cada servicio que queramos ofrecer y actualizaremos los campos host y port para cada uno de ellos, poniendo localhost si es un servicio local o la ip/hostname del servidor destino si es un servicio externo. En el caso que nos ocupa lo ofrecerá nuestro servidor, por tanto lo dejaremos tal cual lo muestra el ejemplo:</li>
</ul>
<pre class="code bash literal-block">
protocols:
<span class="o">(</span>
        <span class="o">{</span> name: <span class="s2">"ssh"</span>; service: <span class="s2">"ssh"</span>; host: <span class="s2">"localhost"</span>; port: <span class="s2">"22"</span>; probe: <span class="s2">"builtin"</span>; <span class="o">}</span>,
        <span class="o">{</span> name: <span class="s2">"openvpn"</span>; host: <span class="s2">"localhost"</span>; port: <span class="s2">"1194"</span>; probe: <span class="s2">"builtin"</span>; <span class="o">}</span>,
        <span class="o">{</span> name: <span class="s2">"xmpp"</span>; host: <span class="s2">"localhost"</span>; port: <span class="s2">"5222"</span>; probe: <span class="s2">"builtin"</span>; <span class="o">}</span>,
        <span class="o">{</span> name: <span class="s2">"http"</span>; host: <span class="s2">"localhost"</span>; port: <span class="s2">"80"</span>; probe: <span class="s2">"builtin"</span>; <span class="o">}</span>,
        <span class="o">{</span> name: <span class="s2">"ssl"</span>; host: <span class="s2">"localhost"</span>; port: <span class="s2">"443"</span>; probe: <span class="s2">"builtin"</span>; <span class="o">}</span>,
        <span class="o">{</span> name: <span class="s2">"anyprot"</span>; host: <span class="s2">"localhost"</span>; port: <span class="s2">"443"</span>; probe: <span class="s2">"builtin"</span>; <span class="o">}</span>
<span class="o">)</span>;
</pre>
<p>Tan solo queda arrancar el servicio:</p>
<pre class="code bash literal-block">
/etc/init.d/sslh start
</pre>
<p>Para probar si el servicio funciona podemos realizar una conexión desde otra máquina a cualquiera de los servicios definidos al puerto 8081 (tal como hemos configurado). En nuestro ejemplo realizaremos una conexión ssh de prueba desde otra máquina:</p>
<pre class="code bash literal-block">
ssh -p 8081 root@192.168.10.224
</pre>
<p>Y si habéis seguido todos los pasos correctamente os habréis podido conectar sin problemas.</p>
<p>NOTA: Verificad que no existe ningún servicio (p.e. iptables, etc...) que esté bloqueando el acceso.</p>
    </article><div class="pager row">
        <div class="previous col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <div>Post anterior</div>
            <a href="tiquets-primeros-ponentes-NoSQL-matters-BCN-2014.html" rel="prev">Tiquets y primeros ponentes de la NoSQL matters BCN 2014 ya disponibles</a>
        </div>
        <div class="next col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <div>Siguiente post</div>
            <a href="11-cosas-necesitas-saber-devops-11.html" rel="next">11 cosas sobre DevOps (11): Mi tercer patrón DevOps favorito</a>
        </div>
    </div>

                    <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="edyo",
            disqus_url="http://www.entredevyops.es/posts/laboratorio-sslh.html",
        disqus_title="Laboratorio de sslh: Un puerto para dominarlos a todos",
        disqus_identifier="cache/posts/2014-08-27-dacacio-laboratorio-sslh.html",
        disqus_config = function () {
            this.language = "es_ES";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>JavaScript debe estar activado para ver los <a href="http://disqus.com/?ref_noscript" rel="nofollow">comentarios con Disqus.</a>
</noscript>
    <a href="http://disqus.com" class="dsq-brlink" rel="nofollow">Comentarios con <span class="logo-disqus">Disqus</span></a>


    
            <!--End of body content-->
        </div>
    </div>

</div>

<footer><div class="container">
        Suscríbete a nuestro <a href="http://www.entredevyops.es/rss.xml">RSS <i class="fa fa-rss"></i></a> o síguenos en <a href="https://twitter.com/entredevyops">Twitter <i class="fa fa-twitter"></i></a><br>© 2017 Entre Dev Y Ops por los <a href="http://www.entredevyops.es/acerca-de.html#authors">autores</a> bajo <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.es_ES">Licencia <img alt="Licencia Creative Commons" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" height="15px" width="80px"></a> — Powered by <a href="http://getnikola.com">Nikola</a>
    </div>
</footer><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script><script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script><script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script>
        $( "#search-button" ).click(toggle_search);
        function toggle_search() {
            $('#main-navbar').children().each(
                function() {
                    if ($(this).attr('id') != 'search-button') {
                        console.log($(this).attr('id'));
                        $(this).toggle();
                    };
                }
            );
            $( "#search" ).toggle();
        }
    </script><script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25613214-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
