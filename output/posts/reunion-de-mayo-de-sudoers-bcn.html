<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="Entre Dev Y Ops">
<title>Reunión de Mayo de Sudoers BCN | Entre Dev Y Ops</title>
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="../assets/css/edyo.css" rel="stylesheet" type="text/css">
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<meta name="twitter:card" content="summary">
<meta name="og:url" content="http://www.entredevyops.es/posts/reunion-de-mayo-de-sudoers-bcn.html">
<meta name="twitter:site:id" content="370552857">
<meta name="og:title" content="Reunión de Mayo de Sudoers BCN">
<meta name="og:description" content="Sudoers BCN
Sudoers BCN es una reunión, de carácter mensual, organizada, preparada y orientada a administradores de sistemas, pero en el que se habla de muchos temas relacionados con las tecnologías d">
</head>
<body>

<div id="wrap">

    <!-- Menubar -->

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.entredevyops.es/">Entre Dev Y Ops</a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav navbar-right" id="main-navbar">
<li>
<a href="../tags/index.html"><i class="fa fa-tags"></i> Etiquetas</a>
                </li>
<li>
<a href="../archive.html"><i class="fa fa-archive"></i> Archivo</a>
                </li>
<li>
<a href="../podcast.html"><i class="fa fa-microphone"></i> Podcast</a>
                </li>
<li>
<a href="../acerca-de.html"><i class="fa fa-info-circle"></i> Acerca de...</a>

                        </li>
<li id="search-button"><a href="#" class="fa fa-search"></a></li>
                        </ul>
<form method="get" role="search" id="search" action="https://google.es/search" class="nav navbar-form">
<input type="hidden" name="as_sitesearch" value="http://www.entredevyops.es/"><input type="text" name="q" maxlength="255" placeholder="Buscar..." class="form-control"><input type="submit" value="Buscar">
</form>
                
            </div>
<!-- /.navbar-collapse -->
        </div>
    </nav><!-- End of Menubar --><div class="container">
        <div class="body-content">
            <!--Body content-->
    <article class="postbox clearfix"><h1 class="p-name" itemprop="headline name">Reunión de Mayo de Sudoers BCN</h1>

            <ul class="pager">
<li class="previous">
        <a href="testing-automatizacion-Fosdem.html" title="Testing y automatización  en el Fosdem" rel="prev">Post anterior</a>
        </li>
        <li class="next">
            <a href="agenda-proximos-eventos.html" title="Agenda: Próximos eventos" rel="next">Siguiente post</a>
        </li>
    </ul>
<div class="meta">
            <small>
                por <span class="author">Ignasi Fosch</span>
                el <time class="published" datetime="2013-05-08T20:37:37+02:00">08/05/2013</time>
                
                en     <span itemprop="keywords">
        <a class="tag p-category" href="../tags/alta-disponibilidad.html"><span class="badge badge-info">Alta disponibilidad</span></a>
        <a class="tag p-category" href="../tags/balanceo-de-carga.html"><span class="badge badge-info">Balanceo de carga</span></a>
        <a class="tag p-category" href="../tags/cassandra.html"><span class="badge badge-info">Cassandra</span></a>
        <a class="tag p-category" href="../tags/eventos.html"><span class="badge badge-info">Eventos</span></a>
        <a class="tag p-category" href="../tags/ip-virtual-server.html"><span class="badge badge-info">IP Virtual Server</span></a>
        <a class="tag p-category" href="../tags/keepalived.html"><span class="badge badge-info">Keepalived</span></a>
        <a class="tag p-category" href="../tags/open-source.html"><span class="badge badge-info">Open Source</span></a>
        <a class="tag p-category" href="../tags/sudoers-bcn.html"><span class="badge badge-info">Sudoers BCN</span></a>
    </span>

            </small>
        </div>
        <div class="section" id="sudoers-bcn">
<h2>Sudoers BCN</h2>
<p><a class="reference external" href="http://sudoers-barcelona.wikia.com/wiki/Sudoers_Barcelona_Wiki">Sudoers BCN</a> es una reunión, de carácter mensual, organizada, preparada y orientada a administradores de sistemas, pero en el que se habla de muchos temas relacionados con las tecnologías de la Información. Esta reunión se realiza el primer martes de cada mes y suele ubicarse en la FIB, en el Campus Nord de la UPC. En esta ocasión, Roger Torrentsgenerós habló sobre IPVS y Keepalived, mientras que Tomàs Núñez dió una charla sobre Cassandra para sysadmins.</p>
<!-- TEASER_END -->
</div>
<div class="section" id="ha-y-lb-con-keepalived">
<h2><a class="reference external" href="https://www.dropbox.com/s/f21q3gkl5a99vmn/keepalived.pdf">HA y LB con Keepalived</a></h2>
<p><a class="reference external" href="https://twitter.com/trutx">Roger Torrentsgenerós</a> habló sobre los beneficios de unir las funcionalidades del protocolo <a class="reference external" href="http://es.wikipedia.org/wiki/Virtual_Router_Redundancy_Protocol">VRRP</a>, utilizando <a class="reference external" href="http://www.keepalived.org/">Keepalived</a>, y el software <a class="reference external" href="http://www.linuxvirtualserver.org/software/ipvs.html">IPVS</a>.</p>
<div class="section" id="vrrp">
<h3>VRRP</h3>
<p>El protocolo VRRP se utiliza para mantener una IP, denominada IP virtual, o VIP, siempre activa entre dos o más servidores. Esta VIP es sobre la que se da un servicio que queremos que sea altamente disponible. Todos los nodos que participan del cluster HA se comunican por <a class="reference external" href="http://es.wikipedia.org/wiki/IP_Multicast">multicast</a> en la dirección 224.0.0.18, reconociendo a los demás participantes de la VIP por su identificador de router virtual (VRID).</p>
<p>De su experiencia, Roger indicó que hay que ir con cuidado con los siguientes detalles:</p>
<ul class="simple">
<li>Procurar recordar que no provee balanceo de carga (LB).</li>
<li>Procurar evitar utilizar el mismo VRID para dos grupos distintos.</li>
<li>En caso de igualar el último byte de la VIP al VRID utilizado, asegurarse de utilizar un sólo segmento de 24 bits.</li>
<li>Procurar que los servidores ejecuten la misma versión de VRRP.</li>
</ul>
</div>
<div class="section" id="ip-virtual-server">
<h3>IP Virtual Server</h3>
<p>Este software consiste en un módulo de netfilter que proporciona balanceo de carga a nivel de transporte. Funciona en espacio de núcleo, se gestiona con el comando <tt class="docutils literal">ipvsadm</tt>.</p>
<p>Un conjunto de servidores conforman un <em>cluster</em>, en el que uno de ellos es el servidor principal, prestando el servicio a través de éste. En cierto modo, es como si éste servidor se comportase como un <em>proxy</em>, redirigiendo el tráfico a los otros servidores según el nivel de carga.</p>
<p>Del mismo modo que con el VRRP, Roger explicó las consideraciones que ha tenido que aprender a tener presentes:</p>
<ul class="simple">
<li>Tener muy presente que IPVS no provee de alta disponibilidad (HA).</li>
<li>En caso de activar la persistencia (afinidad) con los clientes, en cantidades bajas y impares, el balanceo suele ser ineficiente, por lo que es mejor no activarla salvo en casos justificados (control de sesiones, por ejemplo).</li>
<li>Tener claro que el servidor "principal" tendrá bastante más carga que los demás, por el trabajo de reenviar las peticiones. Esto se exagera en casos en los que se ha elegido mal el algoritmo.</li>
<li>Procurar evitar configuraciones de firewall que puedan crear bucles, que acabarían por reducir la eficiencia del balanceo.</li>
</ul>
</div>
<div class="section" id="keepalived-vrrp-para-ipvs">
<h3>Keepalived: VRRP para IPVS</h3>
<p>Finalmente, Roger explicó cómo es posible combinar el VRRP, protocolo implementado en <a class="reference external" href="http://www.keepalived.org/">Keepalived</a>, con el IPVS, sacando provecho de algunas técnicas. <a class="reference external" href="http://www.keepalived.org/">Keepalived</a> permite:</p>
<ul class="simple">
<li>Uso de scripts para notificación de cambios de estado. En su caso, a parte de para notificar, los utilizan para alterar el entorno de ejecución, como cambiar las reglas del firewall.</li>
<li>Comprobaciones de estado (health checks) en forma de scripts que pueden, como en el caso anterior, ser bastante útiles.</li>
<li>Las funciones de quorum, que permiten especificar cuál es el nivel necesario de quorum para establecer el servicio.</li>
</ul>
<p>A modo de errores típicos, indicó que hay que tener mucho cuidado con las confusiones entre la capa de HA y la de LB. Es necesario tener siempre muy presente que entregar la VIP (HA) no implica dejar de ser el servidor principal del LB, ni que convertirse en el servidor principal del balanceo implica tener la VIP asignada.</p>
<p>Roger contó cómo han acabado implementando, mediante los health checks de <a class="reference external" href="http://www.keepalived.org/">Keepalived</a> y de <a class="reference external" href="http://www.linuxvirtualserver.org/software/ipvs.html">IPVS</a>, un método para poder dejar un servidor fuera del cluster de balanceo y de HA sin parar los servicios, utilizando una comprobación de la presencia de un fichero en particular. Cuando quieren que el servidor esté fuera de servicio, pero seguir pudiendo probar que funciona todo bien, eliminan el fichero y dejan que los health checks hagan su trabajo.</p>
<p>Finalmente, enumeró los principales defectos que ve en <a class="reference external" href="http://www.keepalived.org/">Keepalived</a>:</p>
<ul class="simple">
<li>El logging, enviado a /var/log/messages, es bastante complejo.</li>
<li>No integra la gestión de las reglas del cortafuegos.</li>
</ul>
</div>
</div>
<div class="section" id="cassandra-para-sysadmins">
<h2><a class="reference external" href="http://www.tomas.cat/blog/ca/presentaci%C3%B3-de-cassandra-al-sudoersbcn-diapositives">Cassandra para sysadmins</a></h2>
<p><a class="reference external" href="https://twitter.com/TomasTechNews">Tomàs Núñez</a> nos habló de <a class="reference external" href="http://cassandra.apache.org/">Cassandra</a>, el motor de clave-valor de <a class="reference external" href="http://www.apache.org/">Apache</a>, pero desde el punto de vista de un administrador de sistemas. Las principales razones para utilizar Cassandra son:</p>
<ul class="simple">
<li>La velocidad (3000x en escrituras y 20x en lecturas comparándolo con MySQL),</li>
<li>HA "de serie",</li>
<li>sin SPOF,</li>
<li>escalado lineal con la adición de nodos,</li>
<li>una administración muy sencilla y,</li>
<li>su orientación hacia hardware común.</li>
</ul>
<p>El cambio de paradigma en el modelo, sobretodo para aquellos acostumbrados al modelo relacional, y la falta de algunas herramientas de depuración, son cambios que hay que aceptar si se quiere sacar provecho de sus ventajas.</p>
<div class="section" id="modelo">
<h3>Modelo</h3>
<p>Respecto al cambio de modelo, Tomàs establece las siguientes equivalencias:</p>
<table border="1" class="docutils">
<colgroup>
<col width="54%">
<col width="46%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Cassandra</th>
<th class="head">Relacional</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>Keyspace</td>
<td>BBDD</td>
</tr>
<tr>
<td>ColumnFamily</td>
<td>Tabla</td>
</tr>
<tr>
<td>SSTables</td>
<td>Fichero de datos</td>
</tr>
<tr>
<td>ID+clave+valor+hora</td>
<td>Registro</td>
</tr>
</tbody>
</table>
<p>Aunque también señaló que se trata de un modelo disperso en el que no todos los elementos deben tener los mismos atributos, por lo que permite variar el número de atributos sin bloquear ninguna tabla ni parar ningún servicio.</p>
</div>
<div class="section" id="arquitectura">
<h3>Arquitectura</h3>
<p>Utilizando una arquitectura igual a igual, tal y como explicó Tomàs, Cassandra consiste en una tabla de <em>hash</em> distribuida, que provee de disponibilidad y tolerancia a fallos con un cierto grado de consistencia incrementando la latencia. Dispone de un parámetro que indica el número de veces que se quiere repetir la información (Replication Factor). El sistema de partición y distribución de claves permite valores de 0 a 2 <sup>127</sup>.</p>
<p>Existen cuatro modos de consistencia:</p>
<ul class="simple">
<li>
<em>One</em> y <em>Any</em>: En los que basta con un sólo nodo activo</li>
<li>
<em>Quorum</em>: En el que es necesario un número configurable de nodos funcionando.</li>
<li>
<em>All</em>: en el que es necesario que ningún nodo esté inactivo.</li>
</ul>
<p>Existe un proceso de monitorización, en instalaciones con múltiples nodos, llamado <tt class="docutils literal">gossip</tt> que permite a cada nodo conocer el estado de los otros nodos, su carga, si se están realizando tareas administrativas, etc.</p>
</div>
<div class="section" id="operaciones-e-s">
<h3>Operaciones E/S</h3>
<div class="section" id="escritura">
<h4>Escritura</h4>
<p>Se puede escribir en cualquier nodo, incluso aunque no coincida con el que tiene que almacenar el dato. El nodo que recibe la información la transmite a los nodos que, por la distribución de claves, les corresponde almacenarlo. Éstos nodos lo almacenan en memoria, permitiendo escrituras muy rápidas. Luego, cada cierto tiempo, un proceso escribe los datos a disco.
La escritura en disco no sobreescribe nada, va acumulando las escrituras, evitando búsquedas y movimientos; aunque un proceso separado va haciendo tareas de mantenimiento en la <em>SSTable</em>.</p>
</div>
<div class="section" id="lectura">
<h4>Lectura</h4>
<p>Como las escrituras, se pueden hacer en cualquier nodo. Dependiendo del modo de consistencia, se lo pedirá a un solo nodo, a unos cuantos o a todos, devolviendo el valor más reciente y actualizando los nodos que no estén bien actualizados.</p>
</div>
<div class="section" id="eliminacion">
<h4>Eliminación</h4>
<p>El nodo que contiene los datos, recibe la eliminación y marca el dato con una "lápida" y la distribuye. Periódicamente, un proceso borra todos los datos con lápida y hora suficientemente antiguas.</p>
</div>
</div>
<div class="section" id="para-sysadmins">
<h3>Para sysadmins</h3>
<p>Tomàs explicó que la instalación es muy sencilla, dado que se trata de un programa en Java que requiere la JVM de Sun, al que sólo hay unos pocos parámetros que configurarle:</p>
<ul class="simple">
<li>La dirección de servicio (<tt class="docutils literal">rpc address</tt>)</li>
<li>El directorio donde ubicar las <em>SSTable</em> (<tt class="docutils literal">data file directories</tt>)</li>
<li>El directorio donde almacenar el registro (<tt class="docutils literal">commit log directory</tt>)</li>
<li>El directorio donde guardar las caches (<tt class="docutils literal">saved caches directory</tt>)</li>
</ul>
<p>Además, si se está configurando en un <em>cluster</em>, hay los siguientes parámetros:</p>
<ul class="simple">
<li>El nombre del <em>cluster</em> (<tt class="docutils literal">cluster name</tt>)</li>
<li>El valor del <em>token</em> inicial (<tt class="docutils literal">initial token</tt>)</li>
<li>La dirección de escucha del proceso de sincronización (<tt class="docutils literal">listen address</tt>)</li>
<li>Las semillas para las claves (<tt class="docutils literal">seeds</tt>)</li>
</ul>
<p><a class="reference external" href="http://cassandra.apache.org/">Cassandra</a>, tal y como contó Tomàs, dispone de un cliente y permite la utilización de una especie de variante de SQL, llamada CQL. Las búsquedas sobre información no presente en la clave se realizan sobre índices secundarios, que se materializan como una <em>SSTable</em> más, pero se garantizan escrituras atómicas con la <em>SSTable</em> que contiene la información. Existe una utilidad básica de administració del cluster que se llama <tt class="docutils literal">nodetool</tt>.</p>
<div class="section" id="para-aumentar-la-capacidad">
<h4>Para aumentar la capacidad</h4>
<p>Hay varias formas de aumentar la capacidad, tal y como contó Tomàs:</p>
<ul class="simple">
<li>Se pueden añadir más discos, o más nodos.</li>
<li>Mover elementos existentes, utilizando el comando <tt class="docutils literal">notetool move</tt>.</li>
<li>Si hay duplicados, se puede recolocar convenientemente.</li>
<li>Redistribuir los datos, con el comando <tt class="docutils literal">nodetool rebuild</tt>.</li>
<li>En el resto de nodos, se puede eliminar la información redundante, utiliando <tt class="docutils literal">nodetool clean</tt> o <tt class="docutils literal">nodetool stub</tt>.</li>
</ul>
</div>
<div class="section" id="para-realizar-copias-de-seguridad">
<h4>Para realizar copias de seguridad</h4>
<p>A nivel de servidor, se pueden hacer instantáneas (<em>snapshots</em>). Además, utilizando enlaces duros (<em>hard links</em>) se pueden conseguir copias de seguridad completas sin consumo de disco adicional.</p>
<p>A nivel de cluster, será necesario espacio para copiar todos los nodos (espacio de disco * factor de replicación). Una opción es tener un cluster con un solo nodo.</p>
</div>
<div class="section" id="para-reducir-la-entropia">
<h4>Para reducir la entropía</h4>
<p>En el caso que un nodo se encuentre fuera de línea, al recuperarse, es necesario verificar toda la información de éste comparándola con el resto de nodos, utilizando el comando <tt class="docutils literal">nodetool repair</tt>.</p>
</div>
<div class="section" id="para-monitorizarlo">
<h4>Para monitorizarlo</h4>
<p>A parte de las técnicas habituales de monitorización, el comando <tt class="docutils literal">nodetool</tt> tiene opciones de generación de estadísticas de consumo de red, de estado de los nodos y demás. Al ser una aplicación Java, JMX es una buena opción. Con JMX se puede monitorizar el <em>Garbage collector</em>, la memoria (<em>heap</em> y no <em>heap</em>), la latencia, las tareas de compactación y las operaciones por estado (<tt class="docutils literal">ReadStage</tt>, <tt class="docutils literal">MutationStage</tt>, <tt class="docutils literal">GossipStage</tt>).</p>
</div>
<div class="section" id="errores-tipicos">
<h4>Errores típicos</h4>
<p>Tomàs destacó algunos aspectos muy importantes para el correcto funcionamiento de Cassandra:</p>
<ul class="simple">
<li>Es importante utilizar el JNA (<em>Java Natice Access</em>) para mejorar la E/S.</li>
<li>Aunque sea contraintuitivo, es importante no activar RAID 1, 10 ni 5, ni esperar que el uso de una SAN aporte mejora alguna. Utilizar RAID 0, por el contrario, sí que mejorará el funcionamiento.</li>
<li>Es importante utilizar distintos discos para el registro y los ficheros de datos.</li>
<li>En muchas ocasiones, pensar en aumentar el <em>Heap</em> de la JVM podría parecer una buena idea, sin embargo, hay pruebas de que poner más de 8GB no es buena idea, ya que podria retrasar demasiado el <em>garbage collection</em>.</li>
<li>Conviene aumentar el límite de ficheros del sistema (1024).</li>
<li>No es necesario poner un balanceador de carga.</li>
<li>Los volúmenes EBS de Amazon WS no son fiables, en cuanto a rendimiento para ejecutar Cassandra.</li>
</ul>
</div>
</div>
</div>
    </article><div class="pager row">
        <div class="previous col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <div>Post anterior</div>
            <a href="testing-automatizacion-Fosdem.html" rel="prev">Testing y automatización  en el Fosdem</a>
        </div>
        <div class="next col-xs-6 col-sm-6 col-md-6 col-lg-6">
            <div>Siguiente post</div>
            <a href="agenda-proximos-eventos.html" rel="next">Agenda: Próximos eventos</a>
        </div>
    </div>

                    <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="edyo",
            disqus_url="http://www.entredevyops.es/posts/reunion-de-mayo-de-sudoers-bcn.html",
        disqus_title="Reuni\u00f3n de Mayo de Sudoers BCN",
        disqus_identifier="cache/posts/2013-05-07-natx-sudoers.html",
        disqus_config = function () {
            this.language = "es_ES";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>JavaScript debe estar activado para ver los <a href="http://disqus.com/?ref_noscript" rel="nofollow">comentarios con Disqus.</a>
</noscript>
    <a href="http://disqus.com" class="dsq-brlink" rel="nofollow">Comentarios con <span class="logo-disqus">Disqus</span></a>


    
            <!--End of body content-->
        </div>
    </div>

</div>

<footer><div class="container">
        Suscríbete a nuestro <a href="http://www.entredevyops.es/rss.xml">RSS <i class="fa fa-rss"></i></a> o síguenos en <a href="https://twitter.com/entredevyops">Twitter <i class="fa fa-twitter"></i></a><br>© 2017 Entre Dev Y Ops por los <a href="http://www.entredevyops.es/acerca-de.html#authors">autores</a> bajo <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.es_ES">Licencia <img alt="Licencia Creative Commons" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" height="15px" width="80px"></a> — Powered by <a href="http://getnikola.com">Nikola</a>
    </div>
</footer><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script><script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script><script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script>
        $( "#search-button" ).click(toggle_search);
        function toggle_search() {
            $('#main-navbar').children().each(
                function() {
                    if ($(this).attr('id') != 'search-button') {
                        console.log($(this).attr('id'));
                        $(this).toggle();
                    };
                }
            );
            $( "#search" ).toggle();
        }
    </script><script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25613214-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
